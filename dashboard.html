<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Checklist Dashboard</title>
  <link rel="stylesheet" href="style2.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>User Checklist Dashboard</h1>
  <div id="dashboard"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDANwGnTgz2Sd-VS-9tjrsT5FvsUpe2NQc",
      authDomain: "sitevisit2025-6a6ce.firebaseapp.com",
      projectId: "sitevisit2025-6a6ce"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const dashboard = document.getElementById("dashboard");

    function createRow(entry) {
      const row = document.createElement("tr");
      row.className = entry.status === "No" ? "row-error" : "";
      row.innerHTML = `
        <td>${entry.fileKey}</td>
        <td>${entry.item.replace(/Item\s*\d+/i, "").trim()}</td>
        <td>${entry.status}</td>
        <td>${entry.comment || "-"}</td>
      `;
      return row;
    }

    function createFolderNode(name, parent) {
      const folderDiv = document.createElement("div");
      folderDiv.className = "folder";

      const label = document.createElement("div");
      label.className = "folder-label";
      label.textContent = name;

      const content = document.createElement("div");
      content.className = "folder-content";
      content.style.display = "none";

      label.addEventListener("click", () => {
        content.style.display = content.style.display === "none" ? "block" : "none";
      });

      folderDiv.appendChild(label);
      folderDiv.appendChild(content);
      parent.appendChild(folderDiv);
      return content;
    }

    async function loadDashboard() {
      const snapshot = await db.collection("checklists").get();

      snapshot.forEach(doc => {
        const data = doc.data();
        const userSection = document.createElement("div");
        userSection.className = "user-section";

        const userHeader = document.createElement("div");
        userHeader.className = "user-header";
        userHeader.textContent = `User: ${data.userId}`;

        const userContent = document.createElement("div");
        userContent.style.display = "none";

        userHeader.addEventListener("click", () => {
          userContent.style.display = userContent.style.display === "none" ? "block" : "none";
        });

        const checklist = data.checklist || {};
        const entries = [];

        Object.entries(checklist).forEach(([fileKey, items]) => {
          Object.entries(items).forEach(([item, entry]) => {
            entries.push({ fileKey, item, ...entry });
          });
        });

        entries.sort((a, b) => a.fileKey.localeCompare(b.fileKey, undefined, { numeric: true }));

        // Organize entries by folder/subfolder
        const folderMap = {};
        entries.forEach(entry => {
          const parts = entry.fileKey.split("/");
          const root = parts[0];
          const sub = parts.length === 3 ? parts[1] : null;
          const file = parts.slice(-1)[0];

          if (!folderMap[root]) folderMap[root] = {};
          const subMap = folderMap[root];

          if (sub) {
            if (!subMap[sub]) subMap[sub] = [];
            subMap[sub].push(entry);
          } else {
            if (!subMap["__root__"]) subMap["__root__"] = [];
            subMap["__root__"].push(entry);
          }
        });

        Object.entries(folderMap).forEach(([folder, subs]) => {
          const folderNode = createFolderNode(folder, userContent);

          if (subs["__root__"]) {
            const table = document.createElement("table");
            table.innerHTML = `
              <tr>
                <th>File</th>
                <th>Item</th>
                <th>Status</th>
                <th>Comment</th>
              </tr>
            `;
            subs["__root__"].forEach(entry => table.appendChild(createRow(entry)));
            folderNode.appendChild(table);
          }

          Object.entries(subs).forEach(([sub, items]) => {
            if (sub === "__root__") return;
            const subNode = createFolderNode(sub, folderNode);
            const table = document.createElement("table");
            table.innerHTML = `
              <tr>
                <th>File</th>
                <th>Item</th>
                <th>Status</th>
                <th>Comment</th>
              </tr>
            `;
            items.forEach(entry => table.appendChild(createRow(entry)));
            subNode.appendChild(table);
          });
        });

        userSection.appendChild(userHeader);
        userSection.appendChild(userContent);
        dashboard.appendChild(userSection);
      });
    }

    loadDashboard();
  </script>
</body>
</html>
